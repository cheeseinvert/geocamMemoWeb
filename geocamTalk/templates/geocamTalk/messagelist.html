{% extends "geocamTalk/base.html" %}

{% block title%}GeoCam Talk Messages{% endblock %}

{% block content %}
<div id="messages">
<dl id="message_list">
{% for m in gc_msg %}
	<dt id="message_{{m.pk}}">
	  On {{ m.get_date_string }} {{ m.get_author_string}} said
	  {% if m.has_geolocation %}<img src="/resources/geoloc.png" />{%endif%}
	</dt>
	<dd id="message_{{m.pk}}_content">
    	<p>{{ m.content}}</p>
	</dd>
{% endfor %}
</dl>

<a href="/talk/messages/create/">New Message</a>
</div>
{% endblock %}

{% block js %}
<script>
    function populateMessages(html_str) {
    	$('#message_list').html(html_str);
    }

    function refreshMessages() {
    	// messagefeed.json looks like this:
        // [{"content": "The hospital is full, no more beds...", "content_timestamp": "02/19 21:35:52", "has_geolocation": -122.4048743, "author": "Adam Grant"}, 
        //  {"content": "Casualties are littering the streets!", "content_timestamp": "02/19 21:35:29", "has_geolocation": -122.4048743, "author": "Adam Grant"}, 
        //  {"content": "Some crazy stuff is happening in this neighborhood.", "content_timestamp": "02/19 21:34:46", "has_geolocation": -122.4048743, "author": "Adam Grant"}]
        $.getJSON('/talk/messagefeed.json', function(data) {
            var html_str = "";	
        	for (var i in data) {
        		var msg = data[i];
        		var pk = msg['pk'];
        		var content = msg['content'];
        		var content_timestamp = msg['content_timestamp'];
        		var has_geolocation = msg['has_geolocation'];
        		var author = msg['author'];
        		
        		html_str += '<dt id="message_'+pk+'">';
        		html_str += 'On '+content_timestamp+' '+author+' said';
        		if (has_geolocation == true) {
        			html_str += '<img src="/resources/geoloc.png" />';
        		}
        		html_str += '</dt>';
        		html_str += '<dd id="message_'+pk+'_content">';
        		html_str += '<p>'+content+'</p>';
        		html_str += '</dd>';
        		populateMessages(html_str);
        	}
        });
    }
    
    setInterval( 'refreshMessages()', 3*1000);
</script>
{% endblock %}